{"version":3,"sources":["js/VirtualizedCollection.ts"],"names":[],"mappings":"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","file":"VirtualizedCollection.js","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IObservableCollection, CollectionChange } from './interfaces';\n\nclass LoadCancellationToken {\n    isCancelled: boolean;\n}\n\nclass DataWindow<TData> {\n    private _dataSourceLength: number;\n    private _data: TData[];\n    private _length: number = 0;\n    private _offsetFromDataSource: number = -1;\n\n    private loadFunction: (offset: number, count: number) => Promise<TData[]>;\n    private lastLoadCancellationToken: LoadCancellationToken;\n    private loadCompleteCallback: (start: number, end: number) => void;\n    private placeholderItemGenerator: (index: number) => TData;\n\n    constructor(dataSourceLength: number,\n                loadFunction: (offset: number, count: number) => Promise<TData[]>,\n                placeholderItemGenerator: (index: number) => TData,\n                loadCompleteCallback: (start: number, end: number) => void) {\n        this._dataSourceLength = dataSourceLength;\n        this.loadFunction = loadFunction;\n        this.placeholderItemGenerator = placeholderItemGenerator;\n        this.loadCompleteCallback = loadCompleteCallback;\n    }\n\n    getStartIndex(): number {\n        return this._offsetFromDataSource;\n    }\n\n    getEndIndex(): number {\n        return this._offsetFromDataSource + this._length;\n    }\n\n    contains(dataSourceIndex: number): boolean {\n        return dataSourceIndex >= this.getStartIndex() && dataSourceIndex < this.getEndIndex();\n    }\n\n    getItem(index: number): TData {\n        if (!this._data) {\n            return this.placeholderItemGenerator(index);\n        }\n        return this._data[index - this._offsetFromDataSource];\n    }\n\n    positionWindow(offset: number, length: number): void {\n        this._offsetFromDataSource = offset;\n        this._length = length;\n        this._data = undefined;\n\n        if (this.lastLoadCancellationToken) {\n            this.lastLoadCancellationToken.isCancelled = true;\n        }\n\n        if (length === 0) {\n            return;\n        }\n\n        let cancellationToken = new LoadCancellationToken();\n        this.lastLoadCancellationToken = cancellationToken;\n        this.loadFunction(offset, length).then(data => {\n            if (!cancellationToken.isCancelled) {\n                this._data = data;\n                this.loadCompleteCallback(this._offsetFromDataSource, this._offsetFromDataSource + this._length);\n            }\n        });\n    }\n}\n\nexport class VirtualizedCollection<TData> implements IObservableCollection<TData> {\n\n    private _length: number;\n    private _windowSize: number;\n    private _bufferWindowBefore: DataWindow<TData>;\n    private _window: DataWindow<TData>;\n    private _bufferWindowAfter: DataWindow<TData>;\n\n    private collectionChangedCallback: (change: CollectionChange, startIndex: number, count: number) => void;\n\n    constructor(windowSize: number,\n                length: number,\n                loadFn: (offset: number, count: number) => Promise<TData[]>,\n                private _placeHolderGenerator: (index: number) => TData) {\n        this._windowSize = windowSize;\n        this._length = length;\n\n        let loadCompleteCallback = (start: number, end: number) => {\n            if (this.collectionChangedCallback) {\n                this.collectionChangedCallback(CollectionChange.ItemsReplaced, start, end - start);\n            }\n        };\n\n        this._bufferWindowBefore = new DataWindow(length, loadFn, _placeHolderGenerator, loadCompleteCallback);\n        this._window = new DataWindow(length, loadFn, _placeHolderGenerator, loadCompleteCallback);\n        this._bufferWindowAfter = new DataWindow(length, loadFn, _placeHolderGenerator, loadCompleteCallback);\n    }\n\n    setCollectionChangedCallback(callback: (change: CollectionChange, startIndex: number, count: number) => void): void {\n        this.collectionChangedCallback = callback;\n    }\n\n    getLength(): number {\n        return this._length;\n    }\n\n    at(index: number): TData {\n        return this.getRange(index, index + 1)[0];\n    }\n\n    getRange(start: number, end: number): TData[] {\n\n        // current data may contain placeholders\n        let currentData = this.getRangeFromCurrent(start, end);\n\n        // only shift window and make promise of refreshed data in following condition:\n        if (start < this._bufferWindowBefore.getStartIndex() || end > this._bufferWindowAfter.getEndIndex()) {\n            // jump, reset\n            this.resetWindowsAroundIndex(start);\n        } else if (end <= this._bufferWindowBefore.getEndIndex()) {\n            // scroll up, shift up\n            let windowToRecycle = this._bufferWindowAfter;\n            this._bufferWindowAfter = this._window;\n            this._window = this._bufferWindowBefore;\n            this._bufferWindowBefore = windowToRecycle;\n            let newWindowOffset = Math.max(0, this._window.getStartIndex() - this._windowSize);\n\n            this._bufferWindowBefore.positionWindow(newWindowOffset, this._window.getStartIndex() - newWindowOffset);\n        } else if (start >= this._bufferWindowAfter.getStartIndex()) {\n            // scroll down, shift down\n            let windowToRecycle = this._bufferWindowBefore;\n            this._bufferWindowBefore = this._window;\n            this._window = this._bufferWindowAfter;\n            this._bufferWindowAfter = windowToRecycle;\n            let newWindowOffset = Math.min(this._window.getStartIndex() + this._windowSize, this._length);\n            let newWindowLength = Math.min(this._length - newWindowOffset, this._windowSize);\n\n            this._bufferWindowAfter.positionWindow(newWindowOffset, newWindowLength);\n        }\n\n        return currentData;\n    }\n\n    private getRangeFromCurrent(start: number, end: number): TData[] {\n        let currentData = [];\n        for (let i = 0; i < end - start; i++) {\n            currentData.push(this.getDataFromCurrent(start + i));\n        }\n\n        return currentData;\n    }\n\n    private getDataFromCurrent(index: number): TData {\n        if (this._bufferWindowBefore.contains(index)) {\n            return this._bufferWindowBefore.getItem(index);\n        } else if (this._bufferWindowAfter.contains(index)) {\n            return this._bufferWindowAfter.getItem(index);\n        } else if (this._window.contains(index)) {\n            return this._window.getItem(index);\n        }\n\n        return this._placeHolderGenerator(index);\n    }\n\n    private resetWindowsAroundIndex(index: number): void {\n\n        let bufferWindowBeforeStart = Math.max(0, index - this._windowSize * 1.5);\n        let bufferWindowBeforeEnd = Math.max(0, index - this._windowSize / 2);\n        this._bufferWindowBefore.positionWindow(bufferWindowBeforeStart, bufferWindowBeforeEnd - bufferWindowBeforeStart);\n\n        let mainWindowStart = bufferWindowBeforeEnd;\n        let mainWindowEnd = Math.min(mainWindowStart + this._windowSize, this._length);\n        this._window.positionWindow(mainWindowStart, mainWindowEnd - mainWindowStart);\n\n        let bufferWindowAfterStart = mainWindowEnd;\n        let bufferWindowAfterEnd = Math.min(bufferWindowAfterStart + this._windowSize, this._length);\n        this._bufferWindowAfter.positionWindow(bufferWindowAfterStart, bufferWindowAfterEnd - bufferWindowAfterStart);\n    }\n}\n"]}